<!doctype html>
<!--
Copyright 2022 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Sample illustrating the use of Payment Handler API.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Payment Handler API Sample</title>
  <script>
    // Add a global error event listener early on in the page load, to help ensure that browsers
    // which don't support specific functionality still end up displaying a meaningful message.
    window.addEventListener('error', function (error) {
      if (ChromeSamples && ChromeSamples.setStatus) {
        console.error(error);
        ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
        error.preventDefault();
      }
    });
    if ('serviceWorker' in navigator) {
      console.log("[app-bc] Payment-App Service worker registration in progress...");

      navigator.serviceWorker
        .register("./sw.js", { scope: "./" })
        .then(function (registration) {
          console.log("[app-bc] registration " + JSON.stringify(registration));

          // Set Registration methods & options (manifest way)
          if (registration.paymentAppManager) {
            registration.paymentAppManager.setManifest({
              name: "app-bc_key",
              options: [{
                enabledMethods: ["basic-card"],
                name: "app-bc for MyCard",
                id: "M. JAUNE D'EAU;4111111111111111;12;25;987"
              }]
            });
          }
          console.log("here" + registration.paymentAppManager);
          console.log("here" + registration.paymentAppManager);
          console.log("here" + registration.paymentAppManager);
          const paymentMethod = "visa card: aaaaaa; password:12345";
          navigator.serviceWorker.controller.postMessage("visa card: aaaaaa; password:12345", {
            paymentMethod: paymentMethod
          });
          // }, {
          //   paymentMethod,

          // });
          // postMessage('PAYMENT_AUTHORIZED', {
          //   paymentMethod,              // Payment method identifier
          // });
          //// Set Registration methods & options
          //if (registration.paymentAppManager) {
          //  registration.paymentAppManager.options.set("app-bc_key", {
          //    enabledMethods: ["basic-card"],
          //    name: "app-bc for MyCard",
          //    id: "M. JAUNE D'EAU;4111111111111111;12;25;987"
          //  });
          //}

          // Forward registration object to the next function
          return (registration);

        }).then(function (sw) {
          // Previous step is successfully completed
          console.log("[app-bc] Payment-App Service Worker is " + (sw.installing || sw.waiting || sw.active).state);

        }).catch(function (exception) {
          alert("[app-bc] Dev.Exception: " + exception);
        });
    }
  </script>






</head>

<body>

  <h3>Live Output</h3>
  <div><button id="buyButton">Buy</button></div>
  <div id="output" class="output">
    <div id="content">
      <div><button id="buyButton">Buy</button></div>
      <div>
        <pre id="result"></pre>
      </div>
    </div>
    <div id="status"></div>
    <pre id="log"></pre>
  </div>


  <script>
//   var ChromeSamples = {
//     log: function() {
//       var line = Array.prototype.slice.call(arguments).map(function(argument) {
//         return typeof argument === 'string' ? argument : JSON.stringify(argument);
//       }).join(' ');

//       document.querySelector('#log').textContent += line + '\n';
//     },

//     clearLog: function() {
//       document.querySelector('#log').textContent = '';
//     },

//     setStatus: function(status) {
//       document.querySelector('#status').textContent = status;
//     },

//     setContent: function(newContent) {
//       var content = document.querySelector('#content');
//       while(content.hasChildNodes()) {
//         content.removeChild(content.lastChild);
//       }
//       content.appendChild(newContent);
//     }
//   };
// </script>









  //
  <script>/**
//  * Builds PaymentRequest for the BobBucks payment method, but does not show any UI yet.
//  *
//  * @return {PaymentRequest} The PaymentRequest oject.
//  */
    // function initPaymentRequest() {
    //   let supportedInstruments = [{
    //     supportedMethods: 'https://bobbucks.dev/pay',
    //   }];

    //   let details = {
    //     total: {label: 'Donation', amount: {currency: 'USD', value: '55.00'}},
    //     displayItems: [
    //       {
    //         label: 'Original donation amount',
    //         amount: {currency: 'USD', value: '65.00'},
    //       },
    //       {
    //         label: 'Friends and family discount',
    //         amount: {currency: 'USD', value: '-10.00'},
    //       },
    //     ],
    //   };

    //   return new PaymentRequest(supportedInstruments, details);
    // }

    // /**
    //  * Invokes PaymentRequest for the BobBucks payment method.
    //  *
    //  * @param {PaymentRequest} request The PaymentRequest object.
    //  */
    // function onBuyClicked(request) {
    //   request.show().then(function(instrumentResponse) {
    //     sendPaymentToServer(instrumentResponse);
    //   })
    //   .catch(function(err) {
    //     ChromeSamples.setStatus(err);
    //   });
    // }

    // /**
    //  * Simulates processing the payment data on the server.
    //  *
    //  * @param {PaymentResponse} instrumentResponse The payment information to
    //  * process.
    //  */
    // function sendPaymentToServer(instrumentResponse) {
    //   // There's no server-side component of these samples. No transactions are
    //   // processed and no money exchanged hands. Instantaneous transactions are not
    //   // realistic. Add a 2 second delay to make it seem more real.
    //   window.setTimeout(function() {
    //     instrumentResponse.complete('success')
    //         .then(function() {
    //           document.getElementById('result').innerHTML =
    //               instrumentToJsonString(instrumentResponse);
    //         })
    //         .catch(function(err) {
    //           ChromeSamples.setStatus(err);
    //         });
    //   }, 2000);
    // }

    // /**
    //  * Converts the payment instrument into a JSON string.
    //  *
    //  * @private
    //  * @param {PaymentResponse} instrument The instrument to convert.
    //  * @return {string} The JSON string representation of the instrument.
    //  */
    // function instrumentToJsonString(instrument) {
    //   let details = instrument.details;

    //   return JSON.stringify({
    //     methodName: instrument.methodName,
    //     details: details,
    //   }, undefined, 2);
    // }

    // const payButton = document.getElementById('buyButton');
    // payButton.setAttribute('style', 'display: none;');
    // if (window.PaymentRequest) {
    //   let request = initPaymentRequest();
    //   payButton.setAttribute('style', 'display: inline;');
    //   payButton.addEventListener('click', function() {
    //     onBuyClicked(request);
    //     request = initPaymentRequest();
    //   });
    // } else {
    //   ChromeSamples.setStatus('This browser does not support web payments');
    // }
    function initPaymentRequest() {
      let supportedInstruments = [{
        supportedMethods: 'https://bobbucks.dev/pay',
      }];

      let details = {
        total: { label: 'Donation', amount: { currency: 'USD', value: '55.00' } },
        displayItems: [
          {
            label: 'Original donation amount',
            amount: { currency: 'USD', value: '65.00' },
          },
          {
            label: 'Friends and family discount',
            amount: { currency: 'USD', value: '-10.00' },
          },
        ],
      };

      let options = {
        requestPayerName: true,
        requestPayerPhone: true,
        requestPayerEmail: true,
      };

      return new PaymentRequest(supportedInstruments, details, options);
    }

    /**
     * Invokes PaymentRequest that also gathers user's contact information.
     *
     * @param {PaymentRequest} request The PaymentRequest object.
     */
    function onBuyClicked(request) {
      request.show().then(function (instrumentResponse) {
        sendPaymentToServer(instrumentResponse);
      })
        .catch(function (err) {
          ChromeSamples.setStatus(err);
        });
    }

    /**
     * Simulates processing the payment data on the server.
     *
     * @private
     * @param {PaymentResponse} instrumentResponse The payment information to
     * process.
     */
    function sendPaymentToServer(instrumentResponse) {
      // There's no server-side component of these samples. No transactions are
      // processed and no money exchanged hands. Instantaneous transactions are not
      // realistic. Add a 2 second delay to make it seem more real.
      window.setTimeout(function () {
        instrumentResponse.complete('success')
          .then(function () {
            document.getElementById('result').innerHTML =
              instrumentToJsonString(instrumentResponse);
          })
          .catch(function (err) {
            ChromeSamples.setStatus(err);
          });
      }, 2000);
    }

    /**
     * Converts the payment instrument into a JSON string.
     *
     * @private
     * @param {PaymentResponse} instrument The instrument to convert.
     * @return {string} The JSON string representation of the instrument.
     */
    function instrumentToJsonString(instrument) {
      let details = instrument.details;

      return JSON.stringify({
        methodName: instrument.methodName,
        details: details,
        payerName: instrument.payerName,
        payerPhone: instrument.payerPhone,
        payerEmail: instrument.payerEmail,
      }, undefined, 2);
    }

    const payButton = document.getElementById('buyButton');
    payButton.setAttribute('style', 'display: none;');
    if (window.PaymentRequest) {
      let request = initPaymentRequest();
      payButton.setAttribute('style', 'display: inline;');
      payButton.addEventListener('click', function () {
        onBuyClicked(request);
        request = initPaymentRequest();
      });
    } else {
      ChromeSamples.setStatus('This browser does not support web payments');
    }
  </script>

</body>

</html>