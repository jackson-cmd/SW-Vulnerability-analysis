const request = require('request');
var fs = require('fs');
let find_script = async (url) => {
  try {
    await request(url, { json: true }, async (err, res, body) => {
      if (err) {
        return console.log(err);
      }
      //console.log(res.body);
      if (
        res.body != undefined &&
        res.body != null &&
        res.body.toString().includes('importScripts')
      ) {
        //await fs.appendFileSync('sw_import.txt', url + '\n');
        start_index = 0;
        while (res.body.indexOf('importScripts', start_index) > 0) {
          start_index = res.body.indexOf('importScripts', start_index);
          end_index = res.body.indexOf(')', start_index);
          let todo = res.body.substring(start_index, end_index);
          if (
            todo.indexOf("'") == -1 &&
            todo.indexOf() == -1 &&
            todo.indexOf('https') == -1
          ) {
            start_index = end_index + 1;
            continue;
          }
          await fs.appendFileSync(
            'sw_import.txt',
            res.body.substring(start_index + 15, end_index - 1) + '\n'
          );
          // await console.log(start_index);
          // await console.log(end_index);
          // await console.log(res.body.substring(start_index, end_index + 1));
          await console.log(url);
          start_index = end_index + 1;
        }

        // let stt = res.body.match('importScripts()');
        // await console.log(stt);
        // await console.log(url);
      }
      // console.log(body.explanation);
    });
  } catch (err) {
    throw err;
    // console.error(err);
  }
};

let pipe = async () => {
  try {
    // read contents of the file
    const data = fs.readFileSync('test.txt', 'UTF-8');

    // split the contents by new line
    const lines = data.split(/\r?\n/);

    // print all lines
    for (let i of lines) {
      //console.log(i);
      await find_script(i);
    }
  } catch (err) {
    throw err;
    // console.error(err);
  }
};
pipe();
